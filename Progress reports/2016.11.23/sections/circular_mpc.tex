In figure \ref{fig:circular_mpc}, the vehicle $C$, whose velocity is constant
and denoted by $v$, is to track a circle whose center is $O'$ and whose
radius is $O'R$. Its orientation relative to the global coordinate system is
$\psi$. $R(x_R, y_R)$ is the point $C$ is to track. The orientation of $R$
relative to the global coordinate system is $\psi_R$. The vehicle's coordinates
are $(x_c, y_c)$.


\begin{figure}[H]\centering
  \scalebox{0.8}{\input{./figures/circular_mpc.tex}}
  \caption{}
  \label{fig:circular_mpc}
\end{figure}

$R$ is a moving reference point and its pose is found as follows. Given $C$ and
the trajectory of the circle, point $R$ is the point with the least distance
to $C$ among all points of the trajectory. Since the circle is known a priori
and comprised by a set of poses, $R$ is known.

The aim is for the vehicle $C$ to minimize its deviation from $R$, in other
words we want to drive the differences

\begin{equation}
  \begin{bmatrix}
    x_c - x_R \\
    y_c -y_R\\
    \psi_c - \psi_R
  \end{bmatrix}
  \rightarrow 0
\end{equation}

\subsubsection{Obtaining the relevant linearized kinematic model}

The model constitutes the equations of motion of the vehicle, and has three
states ($x$, $y$ and $\psi$) and one input ($\delta$). The equations of the
vehicle's motion that are relevant here are

\begin{align}
  \dot{x} &= v cos(\psi + \beta) \\
  \dot{y} &= v sin(\psi + \beta) \\
  \dot{\psi} &= \dfrac{v}{l_r} sin\beta
\end{align}

Sampling with a sampling time of $T_s$ gives

\begin{align}
  x_{k+1} &= x_{k} + T_s v cos(\psi_k + \beta_k) \\
  y_{k+1} &= y_{k} + T_s v sin(\psi_k + \beta_k) \\
  \psi_{k+1} &= \psi_{k} + T_s \dfrac{v}{l_r} sin\beta_k
\end{align}

where

\begin{align}
  \beta_k = tan^{-1}\Big(\dfrac{l_r}{l_r + l_f} tan\delta_{k-1}\Big)
\end{align}


Forming the Jacobians for matrices $A$, $B$ and evaluating them at time
$t=k$ around $\psi = \psi_R$ and $\delta = \delta_{k-1}$ ($\delta_k$ is to be determined at time $k$):

\begin{equation}
 A =
  \begin{bmatrix}
    1 & 0 & -T_s v sin(\psi_R + \beta_k) \\\\
    0 & 1 & T_s v cos(\psi_R + \beta_k) \\\\
    0 & 0 & 1
  \end{bmatrix}
  =
  \begin{bmatrix}
    1 & 0 & -T_s v sin\Big(\psi_R + tan^{-1} (l_q tan\delta_{k-1})\Big) \\\\
    0 & 1 & T_s v cos\Big(\psi_R + tan^{-1} (l_q tan\delta_{k-1})\Big) \\\\
    0 & 0 & 1
  \end{bmatrix}
\end{equation}


\begin{equation}
 B =
  \begin{bmatrix}
    -T_s v sin(\psi_R + \beta_k) \dfrac{l_q}{l_q^2 sin^2\delta_k + cos^2\delta_k} \\
    T_s v cos(\psi_R + \beta_k) \dfrac{l_q}{l_q^2 sin^2\delta_k + cos^2\delta_k} \\
    \dfrac{T_s v}{l_r} cos(\beta_k) \dfrac{l_q}{l_q^2 sin^2\delta_k + cos^2\delta_k}
  \end{bmatrix}
  =
  \begin{bmatrix}
    -T_s v sin\Big(\psi_R + tan^{-1} (l_q tan\delta_{k-1})\Big) \dfrac{l_q}{l_q^2 sin^2\delta_{k-1} + cos^2\delta_{k-1}} \\
    T_s v cos\Big(\psi_R + tan^{-1} (l_q tan\delta_{k-1})\Big) \dfrac{l_q}{l_q^2 sin^2\delta_{k-1} + cos^2\delta_{k-1}} \\
    \dfrac{T_s v}{l_r} cos\Bigg(tan^{-1} \Big(l_q tan\delta_{k-1}\Big)\Bigg) \dfrac{l_q}{l_q^2 sin^2\delta_{k-1} + cos^2\delta_{k-1}}
  \end{bmatrix}
\end{equation}


where $l_q = \dfrac{l_r}{l_r + l_f}$




Now we can express the linear model as

\begin{align}
  s_{k+1} = A s_k + B \delta_k
\end{align}

where

\begin{equation}
  s=
  \begin{bmatrix}
    x_{k} \\
    y_{k} \\
    \psi_{k}
  \end{bmatrix}
\end{equation}


\subsubsection{Stating the optimization problem}

We can now form the optimization problem to be solved at time $t$ as

\begin{align}
  \text{minimize }    & \sum\limits_{k=0}^N (x_k-x_r)^2 q_x + (y_k-y_r)^2 q_y + (\psi_k-\psi_r)^2 q_{\psi} + \delta_k^2 r \\
  \text{subject to }  & s_{k+1} = A s_k + B \delta_k,\text{ where } s_k = [x_k, y_k, \psi_k]^T \\
                      & \delta_{min} \leq \delta_k \leq \delta_{max} \\
                      & (x_r, y_r, \psi_r) \equiv (x_R, y_R, \psi_R) \\
                      & (x_0, y_0, \psi_0) \equiv (x_t, y_t, \psi_t)
\end{align}
